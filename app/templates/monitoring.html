{% extends "base.html" %}

{% block title %}Monitoring{% endblock %}

{% block content %}
<div class="container mt-5">
    <div id="alert-area"></div>
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Test Monitoring</h5>
                    <p class="card-text">Manually trigger connection checks and alerts for testing.</p>
                    <button class="btn btn-primary" onclick="testMonitoring()">
                        <i class="fas fa-sync-alt me-2"></i>Run Connection Check
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Connection Status -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Connection Status</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Client</th>
                                    <th>Status</th>
                                    <th>Last Handshake</th>
                                    <th>Last Alert</th>
                                </tr>
                            </thead>
                            <tbody id="connection-status">
                                <!-- Status will be updated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alert History -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">Alert History</h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Client</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in alerts %}
                                <tr>
                                    <td>{{ alert.sent_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                    <td>{{ alert.client_name }}</td>
                                    <td>{{ alert.subject }}</td>
                                    <td>
                                        {% if alert.success %}
                                        <span class="badge bg-success">Success</span>
                                        {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function formatTimeAgo(timestamp) {
    if (!timestamp || isNaN(new Date(timestamp).getTime())) {
        return 'Never';
    }
    const now = new Date();
    const date = new Date(timestamp);
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return `${Math.floor(seconds / 86400)}d ago`;
}

function updateConnectionStatus() {
    fetch('/api/monitoring/status')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('connection-status');
            tbody.innerHTML = '';
            
            for (const [peer, status] of Object.entries(data.status)) {
                const row = document.createElement('tr');
                
                // Client name
                const clientCell = document.createElement('td');
                clientCell.textContent = status.name || peer;
                
                // Status
                const statusCell = document.createElement('td');
                const statusBadge = document.createElement('span');
                statusBadge.className = `badge ${status.connected ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = status.connected ? 'Connected' : 'Disconnected';
                statusCell.appendChild(statusBadge);
                
                // Last handshake
                const handshakeCell = document.createElement('td');
                handshakeCell.textContent = formatTimeAgo(status.last_handshake);
                
                // Last alert
                const alertCell = document.createElement('td');
                alertCell.textContent = status.last_alert ? 
                    formatTimeAgo(new Date(status.last_alert)) : 'Never';
                
                row.appendChild(clientCell);
                row.appendChild(statusCell);
                row.appendChild(handshakeCell);
                row.appendChild(alertCell);
                
                tbody.appendChild(row);
            }
        })
        .catch(error => console.error('Error updating connection status:', error));
}

function testMonitoring() {
    fetch('/api/monitoring/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <strong>Success!</strong> Connection checks triggered for ${data.results.length} clients.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container');
            const alertArea = document.getElementById('alert-area');
            if (alertArea) {
                alertArea.appendChild(alertDiv);
            } else {
                const row = document.querySelector('.row');
                if (container && row && row.parentNode === container) {
                    container.insertBefore(alertDiv, row);
                } else if (container) {
                    container.appendChild(alertDiv);
                }
            }
            
            // Update status after a short delay
            setTimeout(updateConnectionStatus, 2000);
        } else {
            // Show error message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <strong>Error!</strong> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container');
            const alertArea = document.getElementById('alert-area');
            if (alertArea) {
                alertArea.appendChild(alertDiv);
            } else {
                const row = document.querySelector('.row');
                if (container && row && row.parentNode === container) {
                    container.insertBefore(alertDiv, row);
                } else if (container) {
                    container.appendChild(alertDiv);
                }
            }
        }
    })
    .catch(error => {
        console.error('Error testing monitoring:', error);
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
        alertDiv.innerHTML = `
            <strong>Error!</strong> Failed to trigger connection checks.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        const container = document.querySelector('.container');
        const alertArea = document.getElementById('alert-area');
        if (alertArea) {
            alertArea.appendChild(alertDiv);
        } else {
            const row = document.querySelector('.row');
            if (container && row && row.parentNode === container) {
                container.insertBefore(alertDiv, row);
            } else if (container) {
                container.appendChild(alertDiv);
            }
        }
    });
}

// Update status every 30 seconds
updateConnectionStatus();
setInterval(updateConnectionStatus, 30000);
</script>
{% endblock %} 